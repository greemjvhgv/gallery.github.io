<!DOCTYPE html>
<html>

<head>
  <title>Upload Page</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body class="bg">

  <form class="form">
    <a href="index.html" class="back-link">Back to Gallery</a>
    <h1>Upload a Photo</h1>

    <input type="file" id="fileInput" />
    <img id="preview" src="" alt="Preview will appear here" />

    <input type="text" id="tagsInput" class="tagsinput" placeholder="Enter Tag Here" />

    <button id="uploadBtn" type="button" onclick="uploadImage()" class="button">Upload</button>
    <div id="loader" class="loader" style="display: none;"></div>
    <p id="uploadmessage"></p>
  </form>

</body>

<script>
  const supabaseUrl = 'https://agikgxernopojicgkpfy.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnaWtneGVybm9wb2ppY2drcGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NjE1NDksImV4cCI6MjA3MDEzNzU0OX0.8r5eWuWRhcF9pitenwVM-D-8uXlDGqD4zGDk1PxrmS0';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);


  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('preview');
  const loader = document.getElementById('loader');
  const uploadBtn = document.getElementById('uploadBtn')
  const tagsInput = document.getElementById('tagsInput');
  const UploadMessage = document.getElementById('uploadmessage');
  let selectedFile = null;
  let currentUser = null;


  async function initializePageAuth() {
    const { data: { session }, error } = await supabase.auth.getSession();

    if (error) {
      console.error('Error getting session:', error);
      return;
    }

    if (session) {
      currentUser = session.user; // Store user data
      console.log('User is logged in on upload page:', currentUser.email);
    } else {
      console.log('No active session found on upload page.');
    }
  }

  initializePageAuth();

  fileInput.addEventListener('change', (event) => {
    UploadMessage.innerHTML = "";
    selectedFile = event.target.files[0];
    if (selectedFile) {
      preview.src = URL.createObjectURL(selectedFile);
      preview.style.display = 'block';
      preview.style.maxWidth = '300px';
      preview.style.maxHeight = '400px';
    } else {
      preview.src = '';
      preview.style.display = 'none';
    }
  });

  async function uploadImage() {

    if (!currentUser) {
      alert("You must be logged in to upload photos!");
      UploadMessage.textContent = 'Login required to upload.';
      return; // Stop the function if not logged in
    }

    if (!selectedFile) {
      alert("Please select a file first!");
      return;
    }

    const userId = currentUser.id;
    const filePath = `uploads/${Date.now()}_${selectedFile.name}`;

    loader.style.display = "block";
    UploadMessage.textContent = "";

    const { data, error: uploadError } = await supabase
      .storage
      .from('images')
      .upload(filePath, selectedFile);

    if (uploadError) {
      console.error('Error uploading image:', uploadError);
      UploadMessage.textContent = `Upload failed: ${uploadError.message}`;
      return;
    }

    const { data: publicUrlData } = supabase
      .storage
      .from("images")
      .getPublicUrl(filePath);

    const publicUrl = publicUrlData.publicUrl;

    const tags = document.getElementById('tagsInput').value
      .split(',')
      .map(tag => tag.trim())
      .filter(Boolean);

    const { error: insertError } = await supabase
      .from('photos')
      .insert([{ image_url: publicUrl, tags: tags, user_id: userId }]);

    if (insertError) {
      console.error('Error inserting URL into database:', insertError);
      UploadMessage.textContent = `Database error: ${insertError.message}`;
      return;
    }

    loader.style.display = "none";
    UploadMessage.innerHTML = "- - - - Uploaded! - - - -";
    document.getElementById('tagsInput').value = "";
    selectedFile = null
  }
</script>

</html>